
  <div class="px-10 py-6 mx-auto">
    <h2 class="mb-4 text-xl font-bold text-gray-900">
      Edit product
    </h2>
    <form>
      <input type="hidden" value="<%= product.id %>" name="product_id" id="product_id">
      <h3 class="text-lg py-2 mb-3">Information Product</h3>
      <div class="grid gap-4 mb-4 sm:grid-cols-2 sm:gap-6 sm:mb-5">
        <div class="sm:col-span-2">
          <label
            for="name"
            class="block mb-2 text-sm font-medium text-gray-900"
            >Product name</label
          >
          <input
            type="text"
            autofocus
            value="<%= product.name %>"
            name="name"
            id="product_name"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
            placeholder="Type product name"
            required=""
            autocomplete="off"
          />
        </div>
        <div class="w-full">
          <label for="price_display" class="block mb-2 text-sm font-medium text-gray-900">Price</label>
          <input
            type="text"
            id="price_display"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"
            placeholder=""
            autocomplete="off"
            value="<%= product.price %>"
          />
          <input type="hidden" name="price" id="price" />
        </div>
        <div>
          <label
            for="category"
            class="block mb-2 text-sm font-medium text-gray-900"
            >Category</label
          >
          <select
            id="category"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
          >
            <% categories.forEach(category => { %> <% if (product.category_id
            === category.id) {%>
            <option selected="" value="<%= category.id %>">
              <%= category.name %>
            </option>
            <%} else {%>

            <option value="<%= category.id %>"><%= category.name %></option>
            <%} %> <% }) %>
          </select>
          
        </div>
        
      </div>
      <div>
          <label
            for="stock"
            class="block mb-2 mt-2.5 text-sm font-medium text-gray-900 "
            >Stock</label
          >
          <input
            type="number"
            name="stock"
            id="stock"
            value="<%= product.stock %>"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
            placeholder="Example: 1000"
            required=""
            autocomplete="off"
          />
        </div>
        <div class="sm:col-span-2 mt-5">
          <div class="mb-3">
            <label for="is_discount" class="text-lg text-gray-900">Discount</label>
            <input type="checkbox" name="is_discount" id="is_discount" <% if (product.is_discount) {%> checked <%}%>>
          </div>
        <!-- Tambahkan ID di wrapper discount -->
        <div id="discount_fields" class="grid sm:grid-cols-3 gap-4 hidden">
          <div>
            <label for="discount_percent" class="block mb-2 text-sm font-medium text-gray-900 ">Percent (%)</label>
            <input
              type="number"
              name="discount_percent"
              id="discount_percent"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"
              placeholder="e.g. 10"
              min="0"
              value="<%= product.discount_percent %>"
              max="100"
              autocomplete="off"
            />
          </div>
          <div>
            <label for="discount_start" class="block mb-2 text-sm font-medium text-gray-900 ">Start Date</label>
            <input
              type="datetime-local"
              name="discount_start"
              value="<%= product.discount_start %>"
              id="discount_start"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"
            />
          </div>
          <div>
            <label for="discount_end" class="block mb-2 text-sm font-medium text-gray-900">End Date</label>
            <input
              type="datetime-local"
              name="discount_end"
              value="<%= product.discount_end %>"
              id="discount_end"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5"
            />
          </div>
        </div>
      <br />
      <h3 class="text-lg py-2 mb-3">Spesification Product</h3>
      <div class="grid gap-4 mb-4 sm:grid-cols-2 sm:gap-6 sm:mb-5">
        <div>
          <label
            for="item-weight"
            class="block mb-2 text-sm font-medium text-gray-900"
            >Item Weight (gr)</label
          >
          <input
            type="number"
            name="item-weight"
            id="item-weight"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 "
            value="<%= product.weight %>"
            placeholder="Ex. 12"
            required=""
            autocomplete="off"
          />
        </div>
        <div>
          <label
            for="item-height"
            class="block mb-2 text-sm font-medium text-gray-900 "
            >Item Height (cm)</label
          >
          <input
            type="number"
            name="item-height"
            id="item-height"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
            value="<%= product.height %>"
            placeholder="Ex. 12"
            required=""
            autocomplete="off"
          />
        </div>
        <div>
          <label
            for="item-width"
            class="block mb-2 text-sm font-medium text-gray-900"
            >Item Width (cm)</label
          >
          <input
            type="number"
            name="item-width"
            id="item-width"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
            value="<%= product.width %>"
            placeholder="Ex. 12"
            required=""
            autocomplete="off"
          />
        </div>
      </div>
      <div class="mb-5">
        <div id="editor" class="mb-5"><%- product.description %></div>
      </div>

      <div>
        <!-- Preview area -->
        <%- include("../../components/edit-product-upload-form") %>
      </div>
      <br />
      <div class="grid gap-4 mb-4 sm:grid-cols-2 sm:gap-6 sm:mb-5">
        <div class="flex items-center space-x-4">
          <button
            class="text-white cursor-pointer bg-blue-600 hover:bg-blu e-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center "
          >
            Update Product
          </button>
          <a
            type="button" href="/dashboard/product"
            class="text-red-600 cursor-pointer inline-flex items-center hover:text-white border border-red-600 hover:bg-red-600 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center"
          >
            Cancel
          </a>
        </div>
      </div>
    </form>
  </div>
<%- include("../../components/quill-editor") %>

<script>  
  document.addEventListener("DOMContentLoaded", function () {
    const discountCheckbox = document.getElementById('is_discount');
  const discountFields = document.getElementById('discount_fields');
    if (discountCheckbox.checked) {
      discountFields.classList.remove('hidden');
    } else {
      discountFields.classList.add('hidden');
    }
  discountCheckbox.addEventListener('change', function () {
    
    if (this.checked) {
      discountFields.classList.remove('hidden');
    } else {
      discountFields.classList.add('hidden');
    }
  });
    const form = document.querySelector("form");
  
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      
  
      const formData = new FormData();
  
     // Ambil data form
    const product_id = document.getElementById("product_id").value.trim();
    const name = document.getElementById("product_name").value.trim();
    const price = document.getElementById("price").value.trim();
    const width = document.getElementById("item-width").value.trim();
    const height = document.getElementById("item-height").value.trim();
    const weight = document.getElementById("item-weight").value.trim();
    const description = quill.root.innerHTML.trim();
    const category_id = document.getElementById("category").value.trim();
    const isDiscount = document.getElementById("is_discount").checked;
    const discountPercent = document.getElementById("discount_percent").value.trim();
    const discountStart = document.getElementById("discount_start").value;
    const discountEnd = document.getElementById("discount_end").value;
    const stock = document.getElementById("stock").value.trim()
  
      if (!name || !price || !description || !category_id) {
        alert("Please fill all required fields.");
        return;
      }
      formData.append("product_id", product_id);
      formData.append("category_id", category_id);
    formData.append("product_name", name);
    formData.append("item_width", width);
    formData.append("item_height", height);
    formData.append("item_weight", weight);
    formData.append("product_price", price);
    formData.append("description", description);
        
    formData.append("is_discount", isDiscount || false);
    formData.append("discount_percent", discountPercent || 0);
    formData.append("discount_start", discountStart || null);
    formData.append("discount_end", discountEnd || null);
    
    formData.append("stock", stock);
      
  
      // Tambahkan gambar baru
      selectedFiles.forEach((file) => {
        formData.append("images", file);
      });
  
      // Tambahkan gambar lama (yang tidak dihapus)
      existingImages.forEach((url) => {
        formData.append("existing_images[]", url);
      });
  
      // Kirim ke backend
      fetch("/dashboard/product/edit-product", {
  method: "POST",
  body: formData,
})
  .then(async (response) => {
    const text = await response.text(); // 👈 baca dulu sebagai teks
    console.log("Raw response text:", text); // 👀 lihat isinya
    try {
      const data = JSON.parse(text); // 👈 coba parse manual
      return data;
    } catch (err) {
      throw new Error("Server did not return JSON: " + text); // 🔥 jelas
    }
  })
  .then((data) => {
    alert("Product submitted successfully!");
    window.location.href = "/dashboard/product"
  })
  .catch((error) => {
    alert("Upload error: " + error.message);
  });

    });
  })
  </script>



<script>
  const priceDisplay = document.getElementById('price_display');
  const priceHidden = document.getElementById('price');

  function formatRupiah(value) {
    return new Intl.NumberFormat('<%= website.mata_uang %>', {
      style: 'currency',
      currency: '<%= getLabel(website.mata_uang) %>',
      minimumFractionDigits: 0
    }).format(value);
  }

  priceDisplay.addEventListener('input', function (e) {
    let value = e.target.value.replace(/[^\d]/g, '');
    if (value === "") {
      priceHidden.value = "";
      priceDisplay.value = "";
      return;
    }

    priceHidden.value = value;
    priceDisplay.value = formatRupiah(value);
  });

  // Format saat halaman pertama kali dimuat (jika value sudah ada)
  document.addEventListener('DOMContentLoaded', function () {
    const initialValue = priceDisplay.value.replace(/[^\d]/g, '');
    if (initialValue) {
      priceHidden.value = initialValue;
      priceDisplay.value = formatRupiah(initialValue);
    }
  });
</script>
